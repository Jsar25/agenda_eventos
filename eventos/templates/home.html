{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Homepage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/dise.css' %}">
    <script src="{% static 'js/main.js' %}"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar px-3">
        <a href="#" class="btn btn-outline-danger btn-logout me-3 btn-lg">
            <i class="bi bi-plus-circle"></i> Crear Evento
        </a>

        <img src="https://uees.edu.ec/wp-content/uploads/2021/03/logo-uees-blanco-index.png" alt="UESS" class="navbar-logo">
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-logout btn-lg">
                <i class="bi bi-box-arrow-right"></i> Cerrar sesión
        </button>
    </form>
    </nav>

<div class="container mt-4">
    <h3>Bienvenido, {{ user.username }}!</h3>

    <div class="view-toggle mb-3 text-end">
        <button id="btnTarjeta" class="btn btn-primary active">Vista Tarjeta</button>
        <button id="btnCalendario" class="btn btn-secondary">Vista Calendario</button>
    </div>

    <!-- TARJETAS -->
    <div id="eventRow" class="row mt-3">
        {% for evento in eventos %}
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                {% if evento.imagen_url %}
                    <img src="{{ evento.imagen_url }}" class="card-img-top" alt="{{ evento.titulo }}">
                {% endif %}
                <div class="card-body">
                    <h5 class="card-title">{{ evento.titulo }}</h5>
                    <p class="card-text">{{ evento.descripcion|truncatewords:20 }}</p>
                    <button class="btn btn-primary btn-open-register"
                        data-event-id="{{ evento.id }}"
                        data-event-title="{{ evento.titulo }}"
                        data-event-fecha="{{ evento.fecha_inicio|date:'Y-m-d H:i' }}"
                        data-capacidad_num="{{ evento.capacidad_num }}">                        
                        Registrarse
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- CALENDARIO -->
    <div id="calendarContainer">
        <div id="calendar"></div>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="registroModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formRegistro">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Registro al Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="evento_id" name="evento_id">
                    <div class="mb-2">
                        <label>Título</label>
                        <input type="text" id="event_titulo" readonly class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Fecha</label>
                        <input type="text" id="event_fecha" readonly class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>capacidad_num Disponible</label>
                        <input type="text" name="capacidad_num" id="capacidad_num" readonly class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Nombre</label>
                        <input type="text" name="nombre" id="id_nombre" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label>Correo</label>
                        <input type="email" name="correo" id="id_correo" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Registrarme</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const registroModal = new bootstrap.Modal(document.getElementById('registroModal'));

    // BOTONES DE TARJETAS
    document.querySelectorAll('.btn-open-register').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            document.getElementById('evento_id').value = btn.dataset.eventId;
            document.getElementById('event_titulo').value = btn.dataset.eventTitle;
            document.getElementById('event_fecha').value = btn.dataset.eventFecha;
            document.getElementById('capacidad_num').value = btn.dataset.capacidad_num;
            registroModal.show();
        });
    });

    // CALENDARIO
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: [
            {% for evento in eventos %}
            {
                title: "{{ evento.titulo|escapejs }}",
                start: "{{ evento.fecha_inicio|date:'Y-m-d' }}",
                
                extendedProps: {
                    id: "{{ evento.id }}",
                    titulo: "{{ evento.titulo|escapejs }}",
                    fecha: "{{ evento.fecha_inicio|date:'Y-m-d H:i' }}",
                    capacidad_num:  "{{ evento.capacidad_num|escapejs }}"
                }
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            const props = info.event.extendedProps;
            document.getElementById('evento_id').value = props.id;
            document.getElementById('event_titulo').value = props.titulo;
            document.getElementById('event_fecha').value = props.fecha;
            document.getElementById('capacidad_num').value = props.capacidad_num;
            registroModal.show();
        }
    });
    calendar.render();

    // AJAX FORM
    document.getElementById('formRegistro').addEventListener('submit', e => {
        e.preventDefault();
        const eventoId = document.getElementById('evento_id').value;
        const formData = new FormData(e.target);
        fetch("{% url 'registrar_evento' 0 %}".replace('0', eventoId), {
            method: 'POST',
            headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'ok'){
                alert('Registro exitoso, se enviará un correo');
                registroModal.hide();
                e.target.reset();
            } else {
                alert('Error: ' + (data.mensaje || 'Verifica los datos.'));
            }
        })
        .catch(err => {
            console.error(err);
            alert('Error de red o servidor');
            console.log(err)
        });
    });

});

    const eventRow = document.getElementById('eventRow');
    const calendarContainer = document.getElementById('calendarContainer');
    const btnTarjeta = document.getElementById('btnTarjeta');
    const btnCalendario = document.getElementById('btnCalendario');

    btnTarjeta.onclick = () => {
    eventRow.classList.remove('d-none');       // mostrar tarjetas
    calendarContainer.classList.add('d-none'); // ocultar calendario
    btnTarjeta.classList.add('active');
    btnCalendario.classList.remove('active');
}

btnCalendario.onclick = () => {
    eventRow.classList.add('d-none');          // ocultar tarjetas
    calendarContainer.classList.remove('d-none'); // mostrar calendario
    btnCalendario.classList.add('active');
    btnTarjeta.classList.remove('active');

    // fuerza recalculo del calendario
    setTimeout(() => {
        calendar.updateSize();
    }, 100);
};





</script>

</body>
</html>
