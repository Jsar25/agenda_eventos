{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Homepage</title>
    <link rel="icon" type="image/png" href="https://portal.uees.edu.ec/ords/r/ctsi/217/files/static/v621/icons/app-icon-32.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/dise.css' %}">
    <script src="{% static 'js/main.js' %}"></script>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar px-3">
        <!-- Botón crear evento solo para administradores -->
        {% if user.rol == 'admin' %}
        <button type="button" class="btn btn-outline-danger btn-logout me-3 btn-lg" data-bs-toggle="modal" data-bs-target="#crearEventoModal">
            <i class="bi bi-plus-circle"></i> Crear Evento
        </button>
        {% endif %}

        <img src="https://uees.edu.ec/wp-content/uploads/2021/03/logo-uees-blanco-index.png" alt="UESS" class="navbar-logo">
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-logout btn-lg">
                <i class="bi bi-box-arrow-right"></i> Cerrar sesión
        </button>
    </form>
    </nav>

<div class="container mt-4">
    <h3>Bienvenido, {{ user.username }}!</h3>

    <div class="view-toggle mb-3 text-end">
        <button id="btnTarjeta" class="btn btn-primary active">Vista Tarjeta</button>
        <button id="btnCalendario" class="btn btn-secondary">Vista Calendario</button>
    </div>

    <!-- TARJETAS -->
    <div id="eventRow" class="row mt-3">
        {% for evento in eventos %}
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                {% if evento.imagen_url %}
                    <img src="{{ evento.imagen_url }}" class="card-img-top" alt="{{ evento.titulo }}">
                {% endif %}
                <div class="card-body">
                    <h4 class="card-title">{{ evento.titulo }}</h4>
                    <p class="card-text">{{ evento.descripcion|truncatewords:20 }}</p>
                    <p class="card-text"><strong>Ubicación: </strong>{{ evento.lugar}}</p>
                    
                    <!-- Botones de acción -->
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary btn-open-register"
                            data-event-id="{{ evento.id }}"
                            data-event-title="{{ evento.titulo }}"
                            data-event-fecha="{{ evento.fecha_inicio|date:'Y-m-d H:i' }}"
                            data-capacidad_num="{{ evento.capacidad_num }}">                        
                            Registrarse
                        </button>
                        
                        <!-- Botón eliminar solo para administradores -->
                        {% if user.rol == 'admin' %}
                        <button class="btn btn-danger btn-sm btn-eliminar" 
                                data-event-id="{{ evento.id }}" 
                                data-event-title="{{ evento.titulo }}"
                                title="Eliminar evento">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="card-footer text-muted mt-3" >
                        <b>Cupo: </b> {{evento.capacidad_num}}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- CALENDARIO -->
    <div id="calendarContainer">
        <div id="calendar"></div>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="registroModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formRegistro">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Registro al Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="evento_id" name="evento_id">
                    <div class="mb-2">
                        <label>Título</label>
                        <input type="text" id="event_titulo" readonly class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Fecha</label>
                        <input type="text" id="event_fecha" readonly class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Disponible</label>
                        <input type="text" name="capacidad_num" id="capacidad_num" readonly class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Nombre</label>
                        <input type="text" name="nombre" id="id_nombre" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label>Correo</label>
                        <input type="email" name="correo" id="id_correo" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Registrarme</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const registroModal = new bootstrap.Modal(document.getElementById('registroModal'));

    // BOTONES DE TARJETAS
    document.querySelectorAll('.btn-open-register').forEach(btn => {
        btn.addEventListener('click', e => {
            e.preventDefault();
            document.getElementById('evento_id').value = btn.dataset.eventId;
            document.getElementById('event_titulo').value = btn.dataset.eventTitle;
            document.getElementById('event_fecha').value = btn.dataset.eventFecha;
            document.getElementById('capacidad_num').value = btn.dataset.capacidad_num;
            registroModal.show();
        });
    });

    // CALENDARIO
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        events: [
            {% for evento in eventos %}
            {
                title: "{{ evento.titulo|escapejs }}",
                start: "{{ evento.fecha_inicio|date:'Y-m-d' }}",
                
                extendedProps: {
                    id: "{{ evento.id }}",
                    titulo: "{{ evento.titulo|escapejs }}",
                    fecha: "{{ evento.fecha_inicio|date:'Y-m-d H:i' }}",
                    capacidad_num:  "{{ evento.capacidad_num|escapejs }}"
                }
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            const props = info.event.extendedProps;
            document.getElementById('evento_id').value = props.id;
            document.getElementById('event_titulo').value = props.titulo;
            document.getElementById('event_fecha').value = props.fecha;
            document.getElementById('capacidad_num').value = props.capacidad_num;
            registroModal.show();
        }
    });
    calendar.render();

    // AJAX FORM
    document.getElementById('formRegistro').addEventListener('submit', e => {
        e.preventDefault();
        const eventoId = document.getElementById('evento_id').value;
        const formData = new FormData(e.target);
        fetch("{% url 'registrar_evento' 0 %}".replace('0', eventoId), {
            method: 'POST',
            headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'ok'){
                alert('Registro exitoso, se enviará un correo');
                registroModal.hide();
                e.target.reset();
            } else {
                alert('Error: ' + (data.mensaje || 'Verifica los datos.'));
            }
        })
        .catch(err => {
            console.error(err);
            alert('Error de red o servidor');
            console.log(err)
        });
    });

});

    const eventRow = document.getElementById('eventRow');
    const calendarContainer = document.getElementById('calendarContainer');
    const btnTarjeta = document.getElementById('btnTarjeta');
    const btnCalendario = document.getElementById('btnCalendario');

    btnTarjeta.onclick = () => {
    eventRow.classList.remove('d-none');       // mostrar tarjetas
    calendarContainer.classList.add('d-none'); // ocultar calendario
    btnTarjeta.classList.add('active');
    btnCalendario.classList.remove('active');
}

btnCalendario.onclick = () => {
    eventRow.classList.add('d-none');          // ocultar tarjetas
    calendarContainer.classList.remove('d-none'); // mostrar calendario
    btnCalendario.classList.add('active');
    btnTarjeta.classList.remove('active');

    // fuerza recalculo del calendario
    setTimeout(() => {
        calendar.updateSize();
    }, 100);
};

// === JavaScript para Eliminar Eventos ===
document.querySelectorAll('.btn-eliminar').forEach(btn => {
    btn.addEventListener('click', function() {
        const eventoId = this.getAttribute('data-event-id');
        const eventoTitulo = this.getAttribute('data-event-title');
        
        // Confirmación antes de eliminar
        if (confirm(`¿Estás seguro que deseas eliminar el evento "${eventoTitulo}"?\n\nEsta acción no se puede deshacer.`)) {
            // Crear formulario para envío POST
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/eventos/${eventoId}/eliminar/`;
            
            // Agregar token CSRF
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            // Agregar al DOM y enviar
            document.body.appendChild(form);
            form.submit();
        }
    });
});



</script>

<!-- Modal Crear Evento -->
{% if user.rol == 'admin' %}
<div class="modal fade" id="crearEventoModal" tabindex="-1" aria-labelledby="crearEventoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearEventoModalLabel">
                    <i class="bi bi-calendar-plus"></i> Crear Nuevo Evento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'crear_evento' %}" id="crearEventoForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="id_titulo" class="form-label">Título del Evento</label>
                            <input type="text" class="form-control" id="id_titulo" name="titulo" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="id_descripcion" class="form-label">Descripción</label>
                            <textarea class="form-control" id="id_descripcion" name="descripcion" rows="3" required></textarea>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_fecha_inicio" class="form-label">Fecha de Inicio</label>
                            <input type="datetime-local" class="form-control" id="id_fecha_inicio" name="fecha_inicio" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_fecha_fin" class="form-label">Fecha de Fin</label>
                            <input type="datetime-local" class="form-control" id="id_fecha_fin" name="fecha_fin">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_lugar" class="form-label">Lugar</label>
                            <input type="text" class="form-control" id="id_lugar" name="lugar" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_tipo_evento" class="form-label">Tipo de Evento</label>
                            <select class="form-control" id="id_tipo_evento" name="tipo_evento" required>
                                <option value="">Selecciona un tipo</option>
                                <option value="conferencia">Conferencia</option>
                                <option value="taller">Taller</option>
                                <option value="capacitacion">Capacitación</option>
                                <option value="evento_deportivo">Evento Deportivo</option>
                                <option value="evento_cultural">Evento Cultural</option>
                                <option value="seminario">Seminario</option>
                                <option value="reunion">Reunión</option>
                                <option value="ceremonia">Ceremonia</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="id_capacidad_num" class="form-label">Capacidad</label>
                            <input type="number" class="form-control" id="id_capacidad_num" name="capacidad_num" min="1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="id_imagen_url" class="form-label">URL de Imagen (opcional)</label>
                            <input type="url" class="form-control" id="id_imagen_url" name="imagen_url">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="submit" form="crearEventoForm" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Crear Evento
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

</body>
</html>
